# 3D-PML-FEM
## Author:  
Tiaojie Xiao;Tian Shu et al.
## Date:   
2024-11
## Language： 
C++  
If you use this code in your research, please do not use it for commercial purposes and please provide the source.

## Title:
Parallel finite element forward modeling of 3-D magnetotelluric conductivity and permeability anisotropy with coupled PML boundary conditions  

## Contact:   
e-mail xiaotiaojie@nudt.edu.cn    
## Hardware requirements:   
Tianhe-2 Supercomputer    

## Brief Introduction  
This code is for the coupled PML (Perfectly Matched Layer) three-dimensional magnetotelluric anisotropic parallel finite element forward modeling, which includes a single-frequency point parallel test case for model 3 (Figure 11 in the paper).  

This library contains the original data of all the experiments in the paper. 
There are 21 directorys in repository.The LibraryFile file contains the library files that need to be installed. The other directories all contain a complete example, code, experimental data, and running log information (except for the directory of Model 1).
Note that in the experiments of Model 1, we compare our results with those computed using the MATLAB code provided by Yang et al. to verify correctness.Due to MATLAB software licensing restrictions, we only provide the experimental data in the Model 1 directory. Note that due to the same code structure, we only provide standardized and detailed code comments in the model2_PML_single_air file.

## Directory Naming Convention  
The directory naming convention is as follows (note that some fields are not mandatory):
  
`name:     model_boundary_process_model type_main author of the program_permeability type`  
`            |       |        |        |                  |                     |`  
`            |       |        |        |                  |                     |`  
`Field ID:   1       2        3        4                  5                     6`  
### Field Description

| Field | Description                                                                 |
|-------|-----------------------------------------------------------------------------|
| 1     | Indicates which model in the paper it refers to                             |
| 2     | Indicates the adopted boundary conditions                                   |
| 3     | Indicates whether it is single-process or multi-process in parallel         |
| 4     | Indicates the type of model (half-space, air-ground, air-sea-ground, etc.)  |
| 5     | Indicates the main author of the code                                       |
| 6     | Indicates the type of permeability (e.g., μ0 for vacuum permeability)      |
  
Since each directory (except for the Model 1 directory) contains complete information, we will only provide a detailed description of the contents under the "model2_PML_single_air" directory below. Other directories can be referenced accordingly.

  
# ======model2_PML_single_air======
CSAMT：Includes all files except the output files.  
outfile：Includes the output files.  

## CSAMT  

### build：  
It includes the .o files generated by the compilation process. You don't need to pay attention to them. Including output files
### data：  
Input file for the primary field source.Set up different folders (dataset + serial number) according to the number of test frequency points.Taking single-frequency testing as an example, the dataset0 directory contains two files: P2IEx.dat and P2REx.dat.Since we use a plane wave source in the paper, the values of the primary field source computed using the analytical solution depend only on the height Z and have no vertical component.The simulation region has 20 layers of grids in the Z direction, so there are 21 height levels along the X and Y direction edges, resulting in 21 complex values for the primary field source.P2IEx.dat records the imaginary part of the complex numbers; P2REx.dat records the real part of the complex numbers.
### include：  
Contains the header files.
### log： 
We place the log files generated from each run in this directory. The naming convention for log files is log + number of nodes (if multiple nodes are used) + number of processes. The log files are mainly used to record the time spent in each stage. 
### src： 
Source code directory. The internal files and their functions are listed in the table below:  

| filename     | Description                          |
|--------------|--------------------------------------|
| fmodel       | Model setup and meshing. | 
| main         | Main function, which includes MPI-related code and calls code from other files.  |  
| rhoAndpha    | Post-processing: calculates the apparent resistivity and phase based on the computed electric and magnetic fields.  |  
| v0Assembly   | Matrix element calculation and matrix assembly.  |  
| v1Assembly   | A-source solution   |  
| v2Assembly   | B-source solution   |  





# Getting Started
## Installation
Clone  
$ git clone https://github.com/xtj-etac/3D-PML-FEM.git  
$ cd 3D-PML-FEM

## Configure your environment
1、You will need to install the following external libraries:  
gcc9.3.0、mpich、superlu_dist-8.0.0、petsc-3.20.5 

2、Then you need to modify the make.inc file: 
BLAS_DIR     =/Your path/openmp  
LAPACK_DIR   =/Your path/gcc9.3.0  
PARMETIS_DIR =/Your path/parmetis-4.0.3  
METIS_DIR    =/Your path/metis  
SUPERLU_DIST =/Your path/superlu_dist-8.0.0  
EIGEN_DIR     =/Your path/eigen-git-mirror-master  
PETSC_DIR    =/Your path/petsc-3.20.5  

3、Compile your code    
$ make

4、Run your code  
$ sh mybatch.sh X1 X2 (X1 represents the number of nodes used at run time and X2 represents the total number of processes used at run time)  

$notice    
You need to select the mpi run command based on your environment, as shown below:  
mpiexe -n numpro(Number of processes) ./main

# Citation  
If you use this code for your research, please cite the paper.

